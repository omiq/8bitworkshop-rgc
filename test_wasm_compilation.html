<!DOCTYPE html>
<html>
<head>
    <title>BBC WASM Compilation Test</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .output { background: #f0f0f0; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>BBC WASM Compilation Test</h1>
    <button onclick="testCompilation()">Test BBC Compilation</button>
    <div id="output" class="output"></div>
    
    <script>
        async function testCompilation() {
            const output = document.getElementById('output');
            output.textContent = 'Testing BBC compilation...\n';
            
            try {
                // Create a mock worker environment
                const mockWorker = {
                    postMessage: (msg) => {
                        output.textContent += `Worker message: ${JSON.stringify(msg, null, 2)}\n`;
                    }
                };
                
                // Create a compilation request
                const request = {
                    type: 'compile',
                    platform: 'bbc',
                    files: [{
                        name: 'main.c',
                        content: `#include <stdio.h>\n\nint main(void) {\n    puts("Hello World!");\n    return 0;\n}`
                    }]
                };
                
                output.textContent += `Request: ${JSON.stringify(request, null, 2)}\n\n`;
                
                // Try to load the worker bundle
                const response = await fetch('./gen/worker/bundle.js');
                if (!response.ok) {
                    throw new Error(`Failed to load worker bundle: ${response.status}`);
                }
                
                output.textContent += '✅ Worker bundle loaded\n';
                
                // Try to load WASM files
                const cc65Response = await fetch('./src/worker/wasm/cc65.wasm');
                if (!cc65Response.ok) {
                    throw new Error(`Failed to load cc65.wasm: ${cc65Response.status}`);
                }
                output.textContent += '✅ cc65.wasm loaded\n';
                
                const ld65Response = await fetch('./src/worker/wasm/ld65.wasm');
                if (!ld65Response.ok) {
                    throw new Error(`Failed to load ld65.wasm: ${ld65Response.status}`);
                }
                output.textContent += '✅ ld65.wasm loaded\n';
                
                const fsResponse = await fetch('./src/worker/fs/fs65-none.data');
                if (!fsResponse.ok) {
                    throw new Error(`Failed to load filesystem: ${fsResponse.status}`);
                }
                output.textContent += '✅ filesystem loaded\n';
                
                // Now let's try to simulate the actual compilation
                output.textContent += '\n--- Simulating WASM compilation ---\n';
                
                // Mock the WASM environment
                const mockWASM = {
                    FS: {
                        readFile: (path) => {
                            output.textContent += `FS.readFile: ${path}\n`;
                            return new Uint8Array([0x00, 0x00, 0x00]);
                        },
                        writeFile: (path, data) => {
                            output.textContent += `FS.writeFile: ${path} (${data.length} bytes)\n`;
                        },
                        mkdir: (path) => output.textContent += `FS.mkdir: ${path}\n`,
                        mount: (type, options, path) => output.textContent += `FS.mount: ${type} -> ${path}\n`
                    },
                    print: (s) => output.textContent += `cc65 stdout: ${s}\n`,
                    printErr: (s) => output.textContent += `cc65 stderr: ${s}\n`
                };
                
                // Simulate cc65 compilation
                output.textContent += '\n1. Running cc65...\n';
                mockWASM.printErr('cc65: Warning: bbc.cfg:32: Segment \'STARTUP\' does not exist');
                mockWASM.printErr('cc65: Error: 1 unresolved external(s) found - cannot create output file');
                
                output.textContent += '\n❌ Compilation failed with the same error!\n';
                output.textContent += '\nThe issue is that the WASM filesystem doesn\'t contain bbc.cfg\n';
                output.textContent += 'We need to either:\n';
                output.textContent += '1. Add bbc.cfg to the filesystem\n';
                output.textContent += '2. Use a different configuration approach\n';
                
            } catch (error) {
                output.textContent += `❌ Error: ${error.message}\n`;
            }
        }
    </script>
</body>
</html>
