<!DOCTYPE html>
<html>
<head>
    <title>DOSBox Emulator</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: monospace;
            overflow: hidden;
        }
        #jsdos {
            width: 100%;
            height: 100vh;
            display: block;
            outline: none;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: monospace;
            overflow: hidden;
        }
        
        /* Ensure the iframe can receive focus */
        html, body {
            height: 100%;
        }
    </style>
</head>
<body>
    <canvas id="jsdos"></canvas>
    
    <script src="https://js-dos.com/6.22/current/js-dos.js"></script>
    <script>
        let dosInstance = null;
        let fs = null;
        let main = null;
        let ci = null;
        
        // Track whether DOSBox should accept keyboard input
        let dosBoxHasFocus = true; // Start with focus since this is the iframe
        
        // Initialize the emulator
        async function initEmulator() {
            if (isInitialized) {
                console.log("Emulator already initialized, skipping");
                return;
            }
            
            console.log("Initializing DOSBox emulator in iframe...");
            
            const canvas = document.getElementById('jsdos');
            
            try {
                dosInstance = window.Dos(canvas, {
                    wdosboxUrl: "https://js-dos.com/6.22/current/wdosbox.js",
                });

                dosInstance.ready((fileSystem, mainFunction) => {
                    console.log("js-dos ready, extracting Turbo C...");
                    
                    // Store the file system object
                    fs = fileSystem;
                    main = mainFunction;
                    
                    // Extract Turbo C from the zip file
                    fs.extract("res/tc.zip").then(() => {
                        console.log("Turbo C extracted, starting DOS...");
                        
                        // Start DOS and get command interface
                        main(["-c", "cd\\"]).then((commandInterface) => {
                            ci = commandInterface;
                            isInitialized = true;
                            console.log("DOSBox ready with Turbo C available");
                            
                            // Notify parent window that emulator is ready
                            window.parent.postMessage({
                                type: 'emulator_capabilities',
                                capabilities: {
                                    pauseResume: true,
                                    reset: true
                                }
                            }, '*');
                            
                            // Request focus for the iframe
                            window.focus();
                            document.body.focus();
                            
                            // Check for program in URL parameters
                            checkForProgramInURL();
                        }).catch((error) => {
                            console.error("Error starting DOS:", error);
                        });
                    }).catch((error) => {
                        console.error("Error extracting Turbo C:", error);
                    });
                });
            } catch (error) {
                console.error("Error creating js-dos instance:", error);
            }
        }
        
        // Check for program data in URL parameters
        function checkForProgramInURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const programData = urlParams.get('program');
            
            if (programData) {
                try {
                    const program = JSON.parse(decodeURIComponent(programData));
                    loadProgram(program);
                } catch (error) {
                    console.error("Error parsing program data from URL:", error);
                }
            }
        }
        
        // Load a program into the emulator
        function loadProgram(programData) {
            if (!fs || !ci) {
                console.error("Emulator not ready yet");
                return;
            }
            
            console.log("Loading program:", programData);
            
            // Convert program data to source code
            const sourceCode = new TextDecoder().decode(programData);
            const filename = 'program.c';
            
            // Compile and run the program
            compileWithTurboC(sourceCode, filename);
        }
        
        // Track if we've already initialized
        let isInitialized = false;
        
        // Compile C program with Turbo C
        async function compileWithTurboC(sourceCode, filename) {
            if (!fs || !ci) {
                console.error("Emulator not ready for compilation");
                return;
            }
            
            // Convert line endings to DOS format (CRLF)
            const dosSourceCode = sourceCode.replace(/\n/g, '\r\n');
            
            try {
                // Add a small delay to ensure file system is ready
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Delete existing file if it exists
                await ci.shell('DEL \\TC\\' + filename);
                
                // Create the file
                await fs.createFile("\\TC\\" + filename, dosSourceCode);
                console.log("File created successfully: \\TC\\" + filename);
                
                // Compile and run
                await ci.shell('z:rescan');
                await ci.shell('cd c:\\tc');
                await ci.shell('tcc -IC:\\TC\\INCLUDE -LC:\\TC\\LIB c:\\tc\\' + filename);
                await ci.shell('c:\\tc\\' + filename.replace('.c', ''));
                
                console.log("Program compiled and executed successfully");
            } catch (error) {
                console.error("Error during compilation:", error);
            }
        }
        
        // Listen for messages from parent window
        window.addEventListener('message', (event) => {
            console.log("Received message from parent:", event.data);
            
            // Only process messages if emulator is initialized
            if (!isInitialized) {
                console.log("Emulator not initialized yet, ignoring message");
                return;
            }
            
            switch (event.data.type) {
                case 'compiled_program':
                    if (event.data.program && fs && ci) {
                        loadProgram(event.data.program);
                    } else {
                        console.log("Cannot load program - emulator not ready");
                    }
                    break;
                    
                case 'reset':
                    if (ci) {
                        ci.shell('cd\\');
                    }
                    break;
                    
                case 'pause':
                    if (dosInstance && dosInstance.api) {
                        try {
                            dosInstance.api.pauseMainLoop();
                        } catch (error) {
                            console.error("Error pausing:", error);
                        }
                    }
                    break;
                    
                case 'resume':
                    if (dosInstance && dosInstance.api) {
                        try {
                            dosInstance.api.resumeMainLoop();
                        } catch (error) {
                            console.error("Error resuming:", error);
                        }
                    }
                    break;
                    
                case 'stop':
                    if (dosInstance && dosInstance.api) {
                        try {
                            dosInstance.api.pauseMainLoop();
                        } catch (error) {
                            console.error("Error stopping:", error);
                        }
                    }
                    break;
            }
        });
        
        // Initialize when page loads
        window.addEventListener('load', initEmulator);
        
        // Ensure the iframe can receive focus
        document.addEventListener('click', () => {
            document.body.focus();
        });
        
        // Set tabindex to make the body focusable
        document.body.tabIndex = -1;
        
        // Expose functions globally for debugging
        window.checkForProgramInURL = checkForProgramInURL;
        window.loadProgram = loadProgram;
        window.compileWithTurboC = compileWithTurboC;
    </script>
</body>
</html>
