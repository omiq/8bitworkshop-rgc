<!DOCTYPE html>
<html>
<head>
    <title>DOSBox Emulator</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: monospace;
            overflow: hidden;
        }
        #jsdos {
            width: 100%;
            height: 100vh;
            display: block;
            outline: none;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: monospace;
            overflow: hidden;
        }
        
        /* Ensure the iframe can receive focus */
        html, body {
            height: 100%;
        }
    </style>
</head>
<body>
    <canvas id="jsdos"></canvas>
    
    <script src="https://js-dos.com/6.22/current/js-dos.js"></script>
    <script>
        let dosInstance = null;
        let fs = null;
        let main = null;
        let ci = null;
        
        // Track whether DOSBox should accept keyboard input
        let dosBoxHasFocus = true; // Start with focus since this is the iframe
        
        // Initialize the emulator
        async function initEmulator() {
            if (isInitialized) {
                console.log("Emulator already initialized, skipping");
                return;
            }
            
            console.log("Initializing DOSBox emulator in iframe...");
            
            const canvas = document.getElementById('jsdos');
            
            try {
                dosInstance = window.Dos(canvas, {
                    wdosboxUrl: "https://js-dos.com/6.22/current/wdosbox.js",
                });

                dosInstance.ready((fileSystem, mainFunction) => {
                    console.log("js-dos ready, extracting Turbo C...");
                    
                    // Store the file system object
                    fs = fileSystem;
                    main = mainFunction;
                    
                    // Extract Turbo C from the zip file
                    fs.extract("res/tc.zip").then(() => {
                        console.log("Turbo C extracted, starting DOS...");
                        
                        // Start DOS and get command interface
                        main(["-c", "cd\\"]).then((commandInterface) => {
                            ci = commandInterface;
                            isInitialized = true;
                            console.log("DOSBox ready with Turbo C available");
                            
                            // Make important objects available globally for debugging
                            window.ci = ci;
                            window.dosInstance = dosInstance;
                            window.fs = fs;
                            window.main = main;
                            
                            console.log("Global objects available: window.ci, window.dosInstance, window.fs, window.main");
                            
                            // Also make objects available in parent window for debugging
                            try {
                                window.parent.ci = ci;
                                window.parent.dosInstance = dosInstance;
                                window.parent.fs = fs;
                                window.parent.main = main;
                                console.log("Objects also available in parent window: window.parent.ci, window.parent.dosInstance, etc.");
                            } catch (error) {
                                console.log("Could not access parent window directly:", error);
                            }
                            
                            // Send objects to parent window via postMessage for debugging
                            window.parent.postMessage({
                                type: 'debug_objects',
                                objects: {
                                    ci: ci,
                                    dosInstance: dosInstance,
                                    fs: fs,
                                    main: main
                                }
                            }, '*');
                            
                            // Check if keypress simulation methods are available
                            console.log("DOSBox simulateKeyPress method available:", typeof dosInstance.simulateKeyPress === 'function');
                            console.log("DOSBox pause method available:", typeof dosInstance.pause === 'function');
                            console.log("DOSBox resume method available:", typeof dosInstance.resume === 'function');
                            
                            // Check for other possible keypress methods
                            console.log("DOSBox methods:", Object.getOwnPropertyNames(dosInstance));
                            console.log("DOSBox prototype methods:", Object.getOwnPropertyNames(Object.getPrototypeOf(dosInstance)));
                            
                            // Check if there's a keyboard or input method
                            if (dosInstance.keyboard) {
                                console.log("DOSBox keyboard methods:", Object.getOwnPropertyNames(dosInstance.keyboard));
                            }
                            
                            // Notify parent window that emulator is ready
                            window.parent.postMessage({
                                type: 'emulator_capabilities',
                                capabilities: {
                                    pauseResume: true,
                                    reset: true
                                }
                            }, '*');
                            
                            // Request focus for the iframe
                            window.focus();
                            document.body.focus();
                            
                            // Check for program in URL parameters
                            checkForProgramInURL();
                        }).catch((error) => {
                            console.error("Error starting DOS:", error);
                        });
                    }).catch((error) => {
                        console.error("Error extracting Turbo C:", error);
                    });
                });
            } catch (error) {
                console.error("Error creating js-dos instance:", error);
            }
        }
        
        // Check for program data in URL parameters
        function checkForProgramInURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const programData = urlParams.get('program');
            
            if (programData) {
                try {
                    const program = JSON.parse(decodeURIComponent(programData));
                    loadProgram(program);
                } catch (error) {
                    console.error("Error parsing program data from URL:", error);
                }
            }
        }
        
        // Load a program into the emulator
        function loadProgram(programData, filename = 'program.c') {
            if (!fs || !ci) {
                console.error("Emulator not ready yet");
                return;
            }
            
            console.log("Loading program:", programData, "with filename:", filename);
            
            // Convert program data to source code
            const sourceCode = new TextDecoder().decode(programData);
            
            // Compile and run the program
            compileWithTurboC(sourceCode, filename);
        }
        
        // Track if we've already initialized
        let isInitialized = false;
        
        // Compile C program with Turbo C
        async function compileWithTurboC(sourceCode, filename) {
            if (!fs || !ci) {
                console.error("Emulator not ready for compilation");
                return;
            }
            
            // Convert line endings to DOS format (CRLF)
            const dosSourceCode = sourceCode.replace(/\n/g, '\r\n');
            
            try {
                // Add a small delay to ensure file system is ready
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Delete existing file if it exists
                await ci.shell('DEL \\TC\\' + filename);
                
                // Create the file
                await fs.createFile("\\TC\\" + filename, dosSourceCode);
                console.log("File created successfully: \\TC\\" + filename);
                
                // Compile and run
                await ci.shell('z:rescan');
                await ci.shell('cd c:\\tc');
                await ci.shell('tcc -IC:\\TC\\INCLUDE -LC:\\TC\\LIB c:\\tc\\' + filename + ' graphics.lib');
                await ci.shell('c:\\tc\\' + filename.replace('.c', ''));
                
                console.log("Program compiled and executed successfully");
            } catch (error) {
                console.error("Error during compilation:", error);
            }
        }
        
        // Listen for messages from parent window
        window.addEventListener('message', (event) => {
            // Filter out sync messages to reduce console spam
            if (event.data && event.data.type === 'sync_sleep_message') {
                return;
            }
            
            console.log("Received message from parent:", event.data);
            
            // Only process messages if emulator is initialized
            if (!isInitialized) {
                console.log("Emulator not initialized yet, ignoring message");
                return;
            }
            
            switch (event.data.type) {
                case 'compiled_program':
                    if (event.data.program && fs && ci) {
                        const filename = event.data.filename || 'program.c';
                        loadProgram(event.data.program, filename);
                    } else {
                        console.log("Cannot load program - emulator not ready");
                    }
                    break;
                    
                case 'reset':
                    if (ci) {
                        ci.shell('cd\\');
                    }
                    break;
                    
                case 'pause':
                    // Try multiple approaches to pause DOSBox
                    if (dosInstance && dosInstance.simulateKeyPress) {
                        try {
                            // Send ALT-PAUSE keypress to pause DOSBox (DOSBox special key)
                            dosInstance.simulateKeyPress(18, 0); // ALT key down
                            dosInstance.simulateKeyPress(19, 0); // PAUSE key down
                            dosInstance.simulateKeyPress(19, 1); // PAUSE key up
                            dosInstance.simulateKeyPress(18, 1); // ALT key up
                            console.log("DOSBox pause keypress sent (ALT-PAUSE)");
                        } catch (error) {
                            console.error("Error sending pause keypress:", error);
                        }
                    } else if (dosInstance && dosInstance.pause) {
                        try {
                            // Try the pause method if available
                            dosInstance.pause();
                            console.log("DOSBox paused using pause() method");
                        } catch (error) {
                            console.error("Error using pause() method:", error);
                        }
                    } else {
                        console.log("No pause method available - trying to find alternative");
                        // Log available methods for debugging
                        console.log("Available dosInstance methods:", Object.getOwnPropertyNames(dosInstance));
                    }
                    break;
                    
                case 'resume':
                    // Try multiple approaches to resume DOSBox
                    if (dosInstance && dosInstance.simulateKeyPress) {
                        try {
                            // Send ALT-PAUSE keypress again to resume DOSBox (same key toggles pause/resume)
                            dosInstance.simulateKeyPress(18, 0); // ALT key down
                            dosInstance.simulateKeyPress(19, 0); // PAUSE key down
                            dosInstance.simulateKeyPress(19, 1); // PAUSE key up
                            dosInstance.simulateKeyPress(18, 1); // ALT key up
                            console.log("DOSBox resume keypress sent (ALT-PAUSE)");
                        } catch (error) {
                            console.error("Error sending resume keypress:", error);
                        }
                    } else if (dosInstance && dosInstance.resume) {
                        try {
                            // Try the resume method if available
                            dosInstance.resume();
                            console.log("DOSBox resumed using resume() method");
                        } catch (error) {
                            console.error("Error using resume() method:", error);
                        }
                    } else {
                        console.log("No resume method available - trying to find alternative");
                        // Log available methods for debugging
                        console.log("Available dosInstance methods:", Object.getOwnPropertyNames(dosInstance));
                    }
                    break;
                    
                case 'stop':
                    if (dosInstance && dosInstance.simulateKeyPress) {
                        try {
                            // Send CTRL-F9 keypress to kill DOSBox (DOSBox special key)
                            dosInstance.simulateKeyPress(17, 0); // CTRL key down
                            dosInstance.simulateKeyPress(120, 0); // F9 key down
                            dosInstance.simulateKeyPress(120, 1); // F9 key up
                            dosInstance.simulateKeyPress(17, 1); // CTRL key up
                            console.log("DOSBox stop keypress sent (CTRL-F9)");
                        } catch (error) {
                            console.error("Error sending stop keypress:", error);
                        }
                    } else {
                        console.log("simulateKeyPress method not available for stop");
                    }
                    break;
            }
        });
        
        // Initialize when page loads
        window.addEventListener('load', initEmulator);
        
        // Ensure the iframe can receive focus
        document.addEventListener('click', () => {
            document.body.focus();
        });
        
        // Set tabindex to make the body focusable
        document.body.tabIndex = -1;
        
        // Expose functions globally for debugging
        window.checkForProgramInURL = checkForProgramInURL;
        window.loadProgram = loadProgram;
        window.compileWithTurboC = compileWithTurboC;
    </script>
</body>
</html>
